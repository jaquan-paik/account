sudo: required
language: python
python:
- '3.6'

services:
- docker
- mysql

env:
  global:
  - secure: 2NLIzqg5hCGw5J8yPLDGB0u1nfmGBN0WSkg1cnkniaUblHZ1TFs86Ou69dk86l75Yoof/nlUju3vEFBnXoBUVQIyHMh0WwyKnglY2w55wRlVDcBDDFnVAg8d0aOezGs3ghUx+4TYnTRxNzSc32AEBbodlkUYeXiUEgQyr/63DhO8LrheDjtWALSDmtM4FQkWL6llo0E5NON6So5BxZBeY04dh+mwvX5+OBC6En1+6f6dCgjWKGJVTk0QOxA9I/OlgfOm/FNQi9fzKkYQlathSgPipzAlLFJ+a8/r9DRZaHd5i2HEWRmkLVJebS1ot2ly5yQ2K+jy9drVC3kEjE/jDvsx0WhcxSRqaw36PIeMpQIj9gxFNNMRHDV96rh/uE4shsjVhHbjs31RRjwFCMtW87WlHF9vp4u1d3N2H7PaXj1rxaQWGMAhld0+dHsw0a2LERSBrFCL5X3Nh28LdypBwzHYm6QZ0/fpxWGjywVpBdBfzP+V05qLyYSPOvoxlNN0F4c0h3IP7Mk7/NqnXFjrYh3b2wq2H4UtRQHMECn2SDh3WNFyvPxb64U5EXzMki0cMtjbsVEWKFLnfCdkFCeTZXSmAVGp/SKtu2dl5EjrQ7yvE9e2b7Nh9LE8qVjHObbSnzv3AjsHj6PN9oF4PixxvcvPZMZuCt6lLF6GNfraYHA=
  - secure: pVszyLSErkktF8G8fP4LeExPFcm/AliuzTH0jQlIvNTE3ImOgElCxXQW8IRmYpgzSPtNqRiHkhzl1MD7Q55WZXm2eQfITEEpWsHpu+y3K95qH4SXXBnvYEcx0SkT5n7hZ6DIXn0YseY9J4WogX0jh1Vv6/Wy+8y68PY625/8TNLl5I/GI/AIVIakxQ4QY6nIkXiY8rLkvf7PyVQpUMDu2QHUsKa7CB6O+y2JDol3WF4zEtiEWsFAxkE00dvTe98NEgUvtDUMGAsyYbFIHA3kl0W4o9exMw75xPXLGfzx06rY9dYO66+4JHpygRQnBqBopxeJgR2E3k2s37e+8wUNk6T+MxcYrR93Qd0L/ziGYDoJ6Cowz6p11YPHflSRBdt6xJwag8ndBM06o7HMdjAtsbIjgHHdcorCk7CjtGAgQhR4QAO3l60bGGzCt7L51RGIwxvvScJBcqXGqelEw0/GoU0OKiC4Xhb+JKr1ncc7eRUvU/d1nRFUcOvvxeBiqBsi/esWLptmn0dsdrlLiMpFadc3Hw9S6qdOj2E94kT8+nBsVtueP4iku2AybVaPUj7iVFGmG8g7o5zD47wS2rqCj8sGBjPE9jbjpckYzJJBCXxPiepMOr1nOBjvI4ewQcOiI/LgWjqHVWNTuilAvJ0169/gH8x89FS8avbowStwwLY=
  - secure: nrZG66Hhmm7aH2OimyxlaQfIvJR6IkNR76S+zhov6o3kNpnnw4PGtr78whTXBuveeO5QAN/S3qA4yQUryQk0Or6xg3fShDJSVTwTdc92eRRd8kEV72vkP9Iy5p/GwmwB6yEb0JdCH7G+0IO5IDAOEyPnJNUFVgmxB+updiE9YlemAILVCTUKQmbuxwrmrcCuW9T5g1VOF8OOLz3fxqIdZrv2kv5q2CzEy+0KKDGKequDWvQRK2ejrdf8EEJwmZHDhjXITnOQFnduqfnwkU+lbX+1K8PH4ysRb6UxMsADp0NKeymC+aUchrg0qeD+1vIYAxwJS6Dns3EjwHfiktAJ44v1QwhF3GAbiKFkvso0SzZu8JqIHD26Ct+9+pBERPE679+9kp57i3zrTUCfe7cWYNFAyMYs+w1FNMPBMeZlywyGREnxy7l3LcNMk+QrbxdJrqVV1Pbu67BqmjoWZLfhU+JBBeG1qVlhohcU1sHq85C+HzVy6L6F6u0XN01YUwZpJc6ywxpU9BpibActGI2ILzxW4MRkCIGye4IOnkZAjKM8rAKOgZPITbPax3ogt1FAIFAFXkK33fARAZMUeN9/kIR184mx4/WUSv0PuqiA218ns6/ih/igADful2B7Mal2wyVAjYl4a9BASUsNlO3pmOxeCHUEWX8cjccXBw83Bdw=
  - secure: m60wLQKswtwoB31n21Zcqg0+VTICfSnjowLeB4B5Dwi+Fnx4qYPzyvl0Elus1EDGSMRij/UHVS4PjfwXyXpqdfBGC5RjLJFgbEuCCZFNeKGNbJf5tY4zFJXpeReT8cAATnsdAHxMsWb0WowYq8UDPX58jQehcoqRPnv2gzUcm0EHLGrPe/W4vpS0B8BlFiEnxkgCikQgOK5wbVWF6HsEYwYs9IK3KPiIIy2IL/tJOUJ/PnDtWpxAcdmLjkHlFL7sDJFldNkgVq75i7PL4cPLs7NMBNGbwn7gMffmrr8gt/hZIGGvyuAM50iji2TjzqngF8DofxGY0xmA34/z5Ak7lw9EIiNqOZxGCz5M46OjlNdxgIBS4wOL81HiMvcQD9RRDkmxwdrEjDVRgTENejMtGgDeoLf3FMCXQ7DIPZBmbRWJj49ff8Z6lEzmXTcDuz2DDznR0Ij4o8i/A8obndWofUQCY+ZgKjG7J6l/66Q4Sn8P3NkSfQpcI0TOmWJ3wc/mbBBoQSMn1ViECXbcsFJi7tPuPrrJi/457o9U0MiQmNdYkh8Lv/e2MrVdVqFTnYLeqQ1hAq8rxYMoPQMjlGZCQ+k2yuR6WqOx7hbhch9dr9l+P+KDlsqQzipu6O19K57Vai+Zf/K0v5Ld1/mWy0xZBSXBR4pW2aRxe5XDzNH7yGM=
  - secure: hViLtrWbEPLPg8UnvKKwXOxCv2SwYe9ElRowGPOvYfkbKPP6yTbqRnFqg13OPAN4jTB6lH0Ukg+lvz3MBSu8fxO7ye3iwyp5804Uhr5ho/loIBIfTs/TsfxxaCN8+OIfAHeRb5inOPCvoBwtp9IZ1u5N3sYfqCLbLo1cyABlPy02KsAnv6IHZ9wsGn/wHgU5hV3eAjRAhZlHzSsYxbKgxjJX/oEDA+PEqfoo/pXzef6tFAJbahORz/cpvg76yPXz1z5DL4Vmc+/AMzPzJTT5UaVsrmptHv/6QcMR2tbUGh1/ztRujp6IJZ1f+YlSLkzbB639k55ZzLjpzmUkzug2lefxopOpgreITucYXZgDlamumvXubeu+0K99m0tro9okWJ40DWd7vQxxhiWihChgsUloV9f0cl3FEcESTUyCRd1JBA563Xhd3z0x7xwpCm2CvekgdkyTjR0ekLEj0c9+C1w1mDPcKCZkUEdssFFhV3yej7Wm2Jh1ptmi64xWxwDTMUaiHt5IAdA2bK21jsZBgSVh5ImCqjlZSinhwMBig8sO4IhpyJSaEyXU3RboyYwkUJcKrTRXxPlFmyRsodVyycoGm/q6vNXmGTSBXEH5/51GUbXDpJKFYMyaeaba57iHm9+Ckd4DPavrapjy7BRov8oBZwb+Ts9G2TyOLKPFG/A=

  - secure: LicpJlyyyeKkNAdo1b9qQuFudAtenvej+4EkINRg7dm+YnMXq5CKe4eYh800eseveUMPo2DYnEf5dbAsk7LEHsx4qfCZ3aOl3SPGFiLqxbaZ09nbJdHZdN9IK4vtQpCY2Wzd0FiUq05D8nBPtE/ijI1HfVwpEUbI2jUHwIz8MSjazz9Wqq/QP/hKMiguEFLJSFd5Hme0OuLmxasW71qzXB4ENp2pRrd3l66uAz30QaslvOcjcZAyQ5LEWGtZAt04VO38xumk/6H4uKYnfGp0lB6bYXEI3CSDEzoS96GUrrwJj7E/ceTqTkq5tU4GI5qHs0OSWgAiNtowCy/2qWff/gMbvRxIuJdaoKMNyKssqa0GrABrB5Ql3+xBvG+2W+8nXveSPIBbZBAk3jsB9a0rw/RzOKuz5p0ciB453td8/UXkyEYMauyCJX1rHBDMyhd71OLSPM1IDm6tjjofRd2bKFMYL1Qr2ZbbLv3myXP/+oxvxcd6ay9W6niqOvphAk4TVsGMEoL0iCxjfMaxV1CJYcupq83J8TmlmDsNBCtAfzHuinMrUYWa/eDa9iedskqsZEgk/dg749YER4cc69E1t8dLvUkVhxIhz2RE/4/e3leCQLbTkkJZz1EOTBDvibBPq5tyOye2GgoNbgZvk/SEGtVoXO3T+CTgzKCMx8eCz6A=
  - secure: foSQqemYZgaEzvzRjm0DcBlmLzHu3IUYwtHbn2BhrLSIYtFZl47r+F4fgUrqlQZnNS4471vNDVd5T6y7lOsg3dSHE7gy2TljOxLDVrD/8D5ph4zyM5l2IGJu5n5DQOz1KzFD6DyzzTiAVOs/gYYgZ43u+5D2Rl4dMVeRlgpqLZf7sLjqaH2PNKaoThaV+ATSvNw9mJy68I1+kcp06uDuASEufwZZJR9+DtU2pX9XycUY2jEy7oxqxytVigdAZ14xBZiHfkeMruacWCN+8nrnI/8QdVIfEZTgbmsRLe+y6VnjdbwJ+CM7o0NcVOWvS28qi8erEe48B0tcygFiK37JVY1+xnQ4YxSHKwcLTZLtuV8NE7YbiaxiVVdZhDom6zDAYKnFu7bjOb3JXQTBazOYYyKstJgBei+ya9uD92je4+1JgCA4DoZgFLiW7dJ29005FaPKoFhpSi0QfczTEHOHU66ZPLBu0xBAK5FrBldn2AC9kf0dMkmtvsFdEvqx8P/7hvCd7Ds0hxUkaR0zpqU2LrM9ETKH5t9+Ee5UOH6PeRKLVT22S5czMePR1yig2Rz2VKWQH2jXf8mQsWbydKPO2V1+Jzj+ooRbYbbOKDXe60J5jvirt9bfe3A+XTsMWSf+Gfmiw7djEGBz/dJ80iAfYXPFlNF1jOrzmnpT+LKNfIY=
  - secure: w2ktRdxir/t0aLiktQsm5WQE49LZZ2C3Q7Q/Xn3sBY6r7RUCKYZNr71cAThPqPDocAeSGc6FxClddkyC87i55rB2EkzxBwLWcSAWmydue/CV/MSfKncWCaRM5WyeIODzkQa4Ln61c0m0mkdqgcbpyCQuEK2SwTqMlYbKka7T6RldTgB92x6dOwiZMXoCdycg+Ho+zlCXtSaRtO7CBna4JSLjOITWl8jYBfemoU1YAW/6Gzw8F3bAdU3iN25aviizgYLNTnXdAP6lFd631cyBETxUXfTAIz5GZ7AHMB8MQExUoy93yXC9L4zdwPW8KYD8ezQZxtvjbehKzJA6vNVGLf2q1Z107nXxIS6JdH6zvesbnxhiYZxSFzqFk0TdqjbTReJHJsLXV+eEZHGnj7A+IJyRCrMnffx20ESQA6/UFWim+TYvOJgnfQHKs7tcQYQtG0fcvwiI3v1UoEgZudOE2OZ9pBtyFbvjO+YWiTX4FsEDZlZBrJpaLF+htOpR3n79VeQdBEWVOfHdrjsbjnBKKW5X/8NMa8BTP318l0twQ8ufnQ8UjsCr8XOkxy9WmCiNu9LT6LkkxUIwFxCohtJvEh/XoVCGd8PTwV8S0KcFkcNU/XSNw2U3yA+8oG6+lNOAGsMqv0+GsY1HUduaGeAS5zNLeP6S5X8v9mwFen9oAps=
  matrix:
  - ENVIRONMENT=development ACCOUNT_ECR=$DEV_ACCOUNT_ECR AWS_ACCESS_KEY_ID=$DEV_AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY=$DEV_AWS_SECRET_ACCESS_KEY
  - ENVIRONMENT=production ACCOUNT_ECR=$PROD_ACCOUNT_ECR AWS_ACCESS_KEY_ID=$PROD_AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY=$PROD_AWS_SECRET_ACCESS_KEY

install:
- pip3 install -r docs/requirements/development.txt

before_script:
- make settings
- mysql -u root -e "use mysql; UPDATE user SET password=password('root') WHERE user='root'; flush privileges;"

script:
- make lint
- make test
- make check-deprecated

before_deploy:
- pip3 install awscli
- pip3 install ecs-deploy
- bash docs/travis/pre_build.sh
- bash docs/travis/build/account.sh
- bash docs/travis/push/account.sh

deploy:
  provider: script
  script: bash docs/travis/deploy.sh
  on:
    branch: release

after_deploy:
- bash docs/travis/after_deploy.sh
