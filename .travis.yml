sudo: required
language: python
python:
- '3.6'

services:
- docker
- mysql

env:
  global:
  - secure: 2NLIzqg5hCGw5J8yPLDGB0u1nfmGBN0WSkg1cnkniaUblHZ1TFs86Ou69dk86l75Yoof/nlUju3vEFBnXoBUVQIyHMh0WwyKnglY2w55wRlVDcBDDFnVAg8d0aOezGs3ghUx+4TYnTRxNzSc32AEBbodlkUYeXiUEgQyr/63DhO8LrheDjtWALSDmtM4FQkWL6llo0E5NON6So5BxZBeY04dh+mwvX5+OBC6En1+6f6dCgjWKGJVTk0QOxA9I/OlgfOm/FNQi9fzKkYQlathSgPipzAlLFJ+a8/r9DRZaHd5i2HEWRmkLVJebS1ot2ly5yQ2K+jy9drVC3kEjE/jDvsx0WhcxSRqaw36PIeMpQIj9gxFNNMRHDV96rh/uE4shsjVhHbjs31RRjwFCMtW87WlHF9vp4u1d3N2H7PaXj1rxaQWGMAhld0+dHsw0a2LERSBrFCL5X3Nh28LdypBwzHYm6QZ0/fpxWGjywVpBdBfzP+V05qLyYSPOvoxlNN0F4c0h3IP7Mk7/NqnXFjrYh3b2wq2H4UtRQHMECn2SDh3WNFyvPxb64U5EXzMki0cMtjbsVEWKFLnfCdkFCeTZXSmAVGp/SKtu2dl5EjrQ7yvE9e2b7Nh9LE8qVjHObbSnzv3AjsHj6PN9oF4PixxvcvPZMZuCt6lLF6GNfraYHA=
  - secure: pVszyLSErkktF8G8fP4LeExPFcm/AliuzTH0jQlIvNTE3ImOgElCxXQW8IRmYpgzSPtNqRiHkhzl1MD7Q55WZXm2eQfITEEpWsHpu+y3K95qH4SXXBnvYEcx0SkT5n7hZ6DIXn0YseY9J4WogX0jh1Vv6/Wy+8y68PY625/8TNLl5I/GI/AIVIakxQ4QY6nIkXiY8rLkvf7PyVQpUMDu2QHUsKa7CB6O+y2JDol3WF4zEtiEWsFAxkE00dvTe98NEgUvtDUMGAsyYbFIHA3kl0W4o9exMw75xPXLGfzx06rY9dYO66+4JHpygRQnBqBopxeJgR2E3k2s37e+8wUNk6T+MxcYrR93Qd0L/ziGYDoJ6Cowz6p11YPHflSRBdt6xJwag8ndBM06o7HMdjAtsbIjgHHdcorCk7CjtGAgQhR4QAO3l60bGGzCt7L51RGIwxvvScJBcqXGqelEw0/GoU0OKiC4Xhb+JKr1ncc7eRUvU/d1nRFUcOvvxeBiqBsi/esWLptmn0dsdrlLiMpFadc3Hw9S6qdOj2E94kT8+nBsVtueP4iku2AybVaPUj7iVFGmG8g7o5zD47wS2rqCj8sGBjPE9jbjpckYzJJBCXxPiepMOr1nOBjvI4ewQcOiI/LgWjqHVWNTuilAvJ0169/gH8x89FS8avbowStwwLY=
  - secure: nrZG66Hhmm7aH2OimyxlaQfIvJR6IkNR76S+zhov6o3kNpnnw4PGtr78whTXBuveeO5QAN/S3qA4yQUryQk0Or6xg3fShDJSVTwTdc92eRRd8kEV72vkP9Iy5p/GwmwB6yEb0JdCH7G+0IO5IDAOEyPnJNUFVgmxB+updiE9YlemAILVCTUKQmbuxwrmrcCuW9T5g1VOF8OOLz3fxqIdZrv2kv5q2CzEy+0KKDGKequDWvQRK2ejrdf8EEJwmZHDhjXITnOQFnduqfnwkU+lbX+1K8PH4ysRb6UxMsADp0NKeymC+aUchrg0qeD+1vIYAxwJS6Dns3EjwHfiktAJ44v1QwhF3GAbiKFkvso0SzZu8JqIHD26Ct+9+pBERPE679+9kp57i3zrTUCfe7cWYNFAyMYs+w1FNMPBMeZlywyGREnxy7l3LcNMk+QrbxdJrqVV1Pbu67BqmjoWZLfhU+JBBeG1qVlhohcU1sHq85C+HzVy6L6F6u0XN01YUwZpJc6ywxpU9BpibActGI2ILzxW4MRkCIGye4IOnkZAjKM8rAKOgZPITbPax3ogt1FAIFAFXkK33fARAZMUeN9/kIR184mx4/WUSv0PuqiA218ns6/ih/igADful2B7Mal2wyVAjYl4a9BASUsNlO3pmOxeCHUEWX8cjccXBw83Bdw=
  - secure: m60wLQKswtwoB31n21Zcqg0+VTICfSnjowLeB4B5Dwi+Fnx4qYPzyvl0Elus1EDGSMRij/UHVS4PjfwXyXpqdfBGC5RjLJFgbEuCCZFNeKGNbJf5tY4zFJXpeReT8cAATnsdAHxMsWb0WowYq8UDPX58jQehcoqRPnv2gzUcm0EHLGrPe/W4vpS0B8BlFiEnxkgCikQgOK5wbVWF6HsEYwYs9IK3KPiIIy2IL/tJOUJ/PnDtWpxAcdmLjkHlFL7sDJFldNkgVq75i7PL4cPLs7NMBNGbwn7gMffmrr8gt/hZIGGvyuAM50iji2TjzqngF8DofxGY0xmA34/z5Ak7lw9EIiNqOZxGCz5M46OjlNdxgIBS4wOL81HiMvcQD9RRDkmxwdrEjDVRgTENejMtGgDeoLf3FMCXQ7DIPZBmbRWJj49ff8Z6lEzmXTcDuz2DDznR0Ij4o8i/A8obndWofUQCY+ZgKjG7J6l/66Q4Sn8P3NkSfQpcI0TOmWJ3wc/mbBBoQSMn1ViECXbcsFJi7tPuPrrJi/457o9U0MiQmNdYkh8Lv/e2MrVdVqFTnYLeqQ1hAq8rxYMoPQMjlGZCQ+k2yuR6WqOx7hbhch9dr9l+P+KDlsqQzipu6O19K57Vai+Zf/K0v5Ld1/mWy0xZBSXBR4pW2aRxe5XDzNH7yGM=
  - secure: hViLtrWbEPLPg8UnvKKwXOxCv2SwYe9ElRowGPOvYfkbKPP6yTbqRnFqg13OPAN4jTB6lH0Ukg+lvz3MBSu8fxO7ye3iwyp5804Uhr5ho/loIBIfTs/TsfxxaCN8+OIfAHeRb5inOPCvoBwtp9IZ1u5N3sYfqCLbLo1cyABlPy02KsAnv6IHZ9wsGn/wHgU5hV3eAjRAhZlHzSsYxbKgxjJX/oEDA+PEqfoo/pXzef6tFAJbahORz/cpvg76yPXz1z5DL4Vmc+/AMzPzJTT5UaVsrmptHv/6QcMR2tbUGh1/ztRujp6IJZ1f+YlSLkzbB639k55ZzLjpzmUkzug2lefxopOpgreITucYXZgDlamumvXubeu+0K99m0tro9okWJ40DWd7vQxxhiWihChgsUloV9f0cl3FEcESTUyCRd1JBA563Xhd3z0x7xwpCm2CvekgdkyTjR0ekLEj0c9+C1w1mDPcKCZkUEdssFFhV3yej7Wm2Jh1ptmi64xWxwDTMUaiHt5IAdA2bK21jsZBgSVh5ImCqjlZSinhwMBig8sO4IhpyJSaEyXU3RboyYwkUJcKrTRXxPlFmyRsodVyycoGm/q6vNXmGTSBXEH5/51GUbXDpJKFYMyaeaba57iHm9+Ckd4DPavrapjy7BRov8oBZwb+Ts9G2TyOLKPFG/A=

  - secure: genYCwgcgCD7LVFzBqf8daXSp7q5rCs6luPQbcKEyWYcTpq0SM4mS+OF5FvFWlFLEXLGrAAoroV62NQYbDlBNK+58Gwd1MTSEW16Trrxz6B9nSqw8aXXJZ/trZCTtlY0dbwFh7PQ6uVuSWx0flO+s2r9uBrKPs513RSmlHgmJGMbVnrVs/45C7CDrRH9xYap64+8TuHYujPeriAjaaVz+xcQEj5PFs3YQ2fkTu+COvhhRg0Z265BkABNUC+D6rmxv3VY8+49iu6gTcYrJDZmiQfQjxzp8GIEe7cWsz7isYaMdHlzX66d43+nNfHXjDV4ARJ/Ja2jrEVAk1pDmEtnIdXv8uU2b1VUItuaXP3L+1IO+9o9wqqtSvH0lm1ytzAhou52DKr05xfmW3+vE3l+izB5WpZLAxtkwGDGhU63uBndprVCpKaYJuthcQuYJ7nJtTLCwnPQN4cq81JGty+NQTfBQk6eYl5Bs+laTc3ApKuNLBeUcik2iuxUkcJK2ApO9wgw8KEjjd8j0Rf0Vdt2Xoi7sCSsS4eRUdtcnF1ThCSQJYn8ABhrdeYC+pxrn4yzKJVXamgU+JPmvB5Gd9WYROMD8nchN6nvH3mtntWsRIERXPaREe6NFbC6ShyBmbyya0TAM99Ao12j1MkG6dboh1QoNfIEGC/QNMWo6WIbapA=
  - secure: ps1ybY4zbgn0NE41pZ95QG1esNEQHsGtBLrJR13DyKqf1AaCbxewnXIwxn+XtooI60mya+5kKaVh7vjnQpxEbAHRmXAAa0WqL2YyIdaL62Em6ND/LdZkzxCygciR3V0hgCgSqLtihPY0jxiMoyUokU9cJsz2xnjgIY7gdCDxeIsRf85W1q5GCo1+AveBhOPiVf4uEA0goTLU/c9BpR7JCIoOx2co/xK1verrKAIBLyCG/SUi7q97taA8bWQO36YPgTsm9e0mjRLUlDe/vgP2OOpgbuHcDHgiu3WDmcfoHUuGMEtb+n2dhiX+9/yUBJzHJZCj2MGVrKP/mX4pq2RLG4GzKuhuACQGuFiKmus2VIciimP8+/H/lPJXAnlnQtXkZTZvCdITTgF0v86co9cd0rgMeJ+1DiXyaxVXX+K7E2Bv+FpFhWXJVCmWqIxwkjGW/7GcjXLmK5oWlvpyqclIZQxPYAuTx/tFFkM6w4q1EY37JPeA/VZhvEQFEDvstg2lgK3ndDnOjfnU8pq0y7kWV7VpNFas9SW0apX87xmxcPRRHGtCnbqVRwJgefk33ORProgkI5aSt9bDjEStAl4oPXVUxIEGABAqYTV858l7K7Z7EkRTf49pjves8m1x/ogZiFxVokHw3L8eqB32tsy6iCDS08kXUiG3x7z7n4SMrNs=
  - secure: tVl0lbCgyFSKBowYiOmSohDVJ76HpHHaVDqfRC7oy9PNpeM2Rgh9ulU+xXDAIXXr3v//f5oGNWTwrsAKn8rlXTAlIzZ5Lf3UUsAoEfu+VbzjBARt8AM0LuuxoLe9akZSDcq27GwgA0YcF0NfvP15ohtyZonSiz6FA2R1cKT2CZpqBowG8MuW57BLcWi0D22lMnoUDJ/ZCC0A/u67nEcawQ3zW/BS6H85dZlsDYYmP3lppvE7s8aEJw0Uwix4Xe1HZGAmiNzXvaN4AZ+DqbddP+aon2inJsmbS4KxJFxLAPb+T66RKRzLF3hABdv9C3YzRZbZ9O7urxt4lBIx9IMDoY77faPoBnPZ3l1rYQiz1au6HPXDR5mtNu3Lay1xfDTczr/4gJ36ZlWIa1oZdQWwxYB6Nce1OOdjyetRI7WhZT1pwoQ0CsBfAAZc4d6s4NJWLDOf0tdmgQi8SY4Qhv1/u+j/vcWnjIh7UVaGs8V25UigUvhlB37WLjximcPuc+UuqVPcfa0WX+Wxi6mYMwCRqAptRbQ8GOA8maqkGkmBa2P7Qa0rxXuMF84Dn/uSQs+HoWU9nOs7HTjVG3FGoImLAvUvY92x6cG5jnI2z+gYgBDRhgMYQtnkQLNdjE1AFErFMLW9aiq0tq54ZyMQWVSsuX3hu4xkb4AlkWOim93Dszc=
  matrix:
  - ENVIRONMENT=development ACCOUNT_ECR=$DEV_ACCOUNT_ECR AWS_ACCESS_KEY_ID=$DEV_AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY=$DEV_AWS_SECRET_ACCESS_KEY
  - ENVIRONMENT=production ACCOUNT_ECR=$PROD_ACCOUNT_ECR AWS_ACCESS_KEY_ID=$PROD_AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY=$PROD_AWS_SECRET_ACCESS_KEY

install:
- pip3 install -r docs/requirements/development.txt

before_script:
- make settings
- mysql -u root -e "use mysql; UPDATE user SET password=password('root') WHERE user='root'; flush privileges;"

script:
- make lint
- make test
- make check-deprecated

before_deploy:
- pip3 install awscli
- pip3 install ecs-deploy
- bash docs/travis/pre_build.sh
- bash docs/travis/build/account.sh
- bash docs/travis/push/account.sh

deploy:
  provider: script
  script: bash docs/travis/deploy.sh
  on:
    branch: release

after_deploy:
- bash docs/travis/after_deploy.sh
